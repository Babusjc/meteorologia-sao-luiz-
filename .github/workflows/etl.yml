name: Data Pipeline

on:
  schedule:
    - cron: '0 0 * * *'  # Executa diariamente à meia-noite
  workflow_dispatch:

permissions:
  contents: write

jobs:
  download-and-process:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Download data
      run: |
        mkdir -p data/raw
        python scripts/download_data.py --force

    - name: Run ETL process
      env:
        NEON_DB_URL: ${{ secrets.NEON_DB_URL }}
      run: |
        mkdir -p data/processed
        python scripts/etl_local.py

    - name: Train model if data exists
      run: |
        if [ -f "data/processed/processed_weather_data.parquet" ]; then
          echo "Dados processados encontrados, treinando modelo..."
          # Ensure train_model.py exists
          if [ ! -f "scripts/train_model.py" ]; then
            echo "Erro: scripts/train_model.py não encontrado"
            exit 1
          fi
          python scripts/train_model.py
        else
          echo "AVISO: Nenhum dado processado disponível para treinamento"
        fi

    - name: Commit processed data
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add data/processed/* || echo "Nenhum dado processado para adicionar"
        git add models/* || echo "Nenhum modelo para adicionar"
        
        if ! git diff --staged --quiet; then
          git commit -m "Update processed data and models [$(date +%Y-%m-%d)]"
          git push origin main
        else
          echo "Nenhuma mudança para commitar"
        fi

